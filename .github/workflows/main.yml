name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    continue-on-error: false
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install allure-pytest

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/unit
          mkdir -p test-reports

      - name: Run unit tests
        run: |
          poetry run pytest tests/unit/ -v \
            --alluredir=allure-results/unit \
            --junitxml=test-reports/unit-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          TEST_ENV: unit

      - name: Ensure Allure unit results exist
        run: |
          if [ ! -d "allure-results/unit" ] || [ -z "$(ls -A allure-results/unit)" ]; then
            echo '{
              "name": "Unit tests skipped",
              "status": "skipped",
              "stage": "finished",
              "steps": [],
              "labels": [{"name":"suite","value":"Unit"}]
            }' > allure-results/unit/skipped-unit.json
          fi

      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            allure-results/unit/
            test-reports/unit-tests.xml
        if: always()

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always() 
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install allure-pytest

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/integration
          mkdir -p test-reports

      - name: Run integration tests
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed, running skipped test for integration"
            mkdir -p tests/integration
            echo "import pytest
            @pytest.mark.skip(reason='Unit tests failed, integration skipped')
            def test_skipped(): pass
            " > tests/integration/skipped_integration.py
            poetry run pytest tests/integration/skipped_integration.py -v \
              --alluredir=allure-results/integration \
              --junitxml=test-reports/integration-tests.xml
          else
            poetry run pytest tests/integration/ -v \
              --alluredir=allure-results/integration \
              --junitxml=test-reports/integration-tests.xml
          fi
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          TEST_ENV: integration

      - name: Check if Allure results were generated
        run: |
          echo "Checking Allure results directory:"
          ls -la allure-results/integration/ || echo "No Allure results found"
          echo "Checking test reports directory:"
          ls -la test-reports/ || echo "No test reports found"

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            allure-results/integration/
            test-reports/integration-tests.xml
        if: always()
        
  e2e-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: nastya
          POSTGRES_PASSWORD: nastya
          POSTGRES_DB: mydb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d mydb"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5
      mailhog:                           
        image: mailhog/mailhog:v1.0.1
        ports:
          - 1025:1025                     # SMTP порт
          - 8025:8025                     # Веб-интерфейс
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install allure-pytest

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/e2e
          mkdir -p test-reports

      - name: Initialize test database
        run: |
          echo "Running DB init scripts..."
          for script in db-init/*.sql; do
            psql postgresql://nastya:nastya@localhost:5432/mydb -f "$script"
          done

      - name: Run FastAPI app in background
        run: |
          nohup poetry run uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Run e2e tests
        run: |
          poetry run pytest tests/e2e/ -v \
            --alluredir=allure-results/e2e \
            --junitxml=test-reports/e2e-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://nastya:nastya@localhost:5432/mydb
          BASE_URL: http://localhost:8000
          TEST_ENV: e2e

      - name: Ensure Allure e2e results exist
        run: |
          if [ ! -d "allure-results/e2e" ] || [ -z "$(ls -A allure-results/e2e)" ]; then
            echo '{
              "name": "E2E tests skipped",
              "status": "skipped",
              "stage": "finished",
              "steps": [],
              "labels": [{"name":"suite","value":"E2E"}]
            }' > allure-results/e2e/skipped-e2e.json
          fi

      - name: Upload e2e test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            allure-results/e2e/
            test-reports/e2e-tests.xml
        if: always()

  allure-report:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
      - name: Checkout code + history
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Allure
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Prepare Allure results directory
        run: |
          mkdir -p merged-allure-results
          
          # Копируем историю из предыдущего отчета (если есть)
          if [ -d "history" ]; then
            echo "Copying existing history..."
            cp -r history merged-allure-results/
            echo "History files copied: $(find merged-allure-results/history -name '*.json' | wc -l)"
          else
            echo "No existing history found - starting fresh"
          fi
          
          # Копируем новые JSON файлы результатов
          find downloaded-artifacts -name "*.json" -exec cp {} merged-allure-results/ \;
          
          echo "Total JSON files: $(find merged-allure-results -name '*.json' | wc -l)"

      - name: Generate Allure Report with history
        run: |
          json_count=$(find merged-allure-results -name '*.json' | wc -l)
          echo "Total JSON files for report: $json_count"
          
          if [ "$json_count" -gt 0 ]; then
            echo "Generating Allure report with trends..."
            allure generate merged-allure-results/ -o allure-report --clean
            
            # Проверяем что история создалась
            if [ -d "allure-report/history" ]; then
              echo "History directory created successfully"
              echo "History items: $(ls allure-report/history/ | wc -l)"
            else
              echo "Warning: No history directory created"
            fi
          else
            mkdir -p allure-report
            echo "<html><body><h1>Test Reports</h1><p>No test results available.</p></body></html>" > allure-report/index.html
          fi

      - name: Add .nojekyll file
        run: |
          touch allure-report/.nojekyll
          echo "GitHub Pages configuration added"

      - name: Deploy to GitHub Pages with history
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          keep_files: true
          force_orphan: false
  # test-metrics:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, e2e-tests]
  #   if: always()
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Download all test results
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: downloaded-artifacts

  #     - name: Generate test metrics
  #       run: |
  #         # Создаем простой файл с метриками для трендов
  #         mkdir -p test-metrics
          
  #         # Считаем результаты тестов
  #         echo "Generating test metrics..."
          
  #         # Можно добавить скрипт для анализа JUnit XML файлов
  #         cat > test-metrics/metrics.json << 'EOF'
  #         {
  #           "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  #           "commit": "${{ github.sha }}",
  #           "run_id": "${{ github.run_id }}"
  #         }
  #         EOF
          
  #     - name: Upload metrics
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-metrics
  #         path: test-metrics
  #       if: always()